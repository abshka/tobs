"""
Tests for audio transcription module.
"""

import pytest
from pathlib import Path
from unittest.mock import Mock, AsyncMock, MagicMock, patch
from concurrent.futures import ThreadPoolExecutor

from src.media.processors.transcription import (
    WhisperTranscriber,
    TranscriptionCache,
    is_voice_message,
    WHISPER_AVAILABLE,
)


class TestTranscriptionCache:
    """Tests for TranscriptionCache."""

    def test_cache_set_and_get(self):
        """Test basic cache operations."""
        cache = TranscriptionCache(max_size=3)

        cache.set("hash1", "text1")
        assert cache.get("hash1") == "text1"

        cache.set("hash2", "text2")
        assert cache.get("hash2") == "text2"

    def test_cache_eviction(self):
        """Test FIFO eviction when cache is full."""
        cache = TranscriptionCache(max_size=2)

        cache.set("hash1", "text1")
        cache.set("hash2", "text2")
        cache.set("hash3", "text3")  # Should evict hash1

        assert cache.get("hash1") is None
        assert cache.get("hash2") == "text2"
        assert cache.get("hash3") == "text3"

    def test_cache_clear(self):
        """Test cache clearing."""
        cache = TranscriptionCache()
        cache.set("hash1", "text1")
        cache.clear()
        assert cache.get("hash1") is None


class TestIsVoiceMessage:
    """Tests for is_voice_message function."""

    def test_no_media(self):
        """Test message without media."""
        message = Mock()
        message.media = None
        assert is_voice_message(message) is False

    def test_not_document(self):
        """Test message with non-document media."""
        message = Mock()
        message.media = Mock()
        message.media.__class__.__name__ = "MessageMediaPhoto"
        assert is_voice_message(message) is False

    def test_voice_message_with_voice_flag(self):
        """Test voice message with voice attribute."""
        with patch('src.media.processors.transcription.MessageMediaDocument') as MockDocument, \
             patch('src.media.processors.transcription.DocumentAttributeAudio') as MockAudio:

            message = Mock()
            message.media = MockDocument()
            message.media.document = Mock()
            message.media.document.mime_type = "audio/ogg"

            audio_attr = MockAudio()
            audio_attr.voice = True
            message.media.document.attributes = [audio_attr]

            assert is_voice_message(message) is True

    def test_audio_without_voice_flag(self):
        """Test audio message without voice flag."""
        with patch('src.media.processors.transcription.MessageMediaDocument') as MockDocument, \
             patch('src.media.processors.transcription.DocumentAttributeAudio') as MockAudio:

            message = Mock()
            message.media = MockDocument()
            message.media.document = Mock()
            message.media.document.mime_type = "audio/ogg"

            audio_attr = MockAudio()
            audio_attr.voice = False
            message.media.document.attributes = [audio_attr]

            assert is_voice_message(message) is False


@pytest.mark.skipif(not WHISPER_AVAILABLE, reason="faster-whisper not installed")
class TestWhisperTranscriber:
    """Tests for WhisperTranscriber."""

    @pytest.fixture
    def executor(self):
        """Create thread pool executor."""
        return ThreadPoolExecutor(max_workers=1)

    def test_initialization(self, executor):
        """Test transcriber initialization."""
        transcriber = WhisperTranscriber(
            executor=executor,
            model_size="tiny",
            device="cpu",
            compute_type="int8",
        )

        assert transcriber.model_size == "tiny"
        assert transcriber.device == "cpu"
        assert transcriber.compute_type == "int8"
        assert transcriber._initialized is False

    @pytest.mark.asyncio
    async def test_transcribe_nonexistent_file(self, executor):
        """Test transcription of non-existent file."""
        transcriber = WhisperTranscriber(executor=executor, model_size="tiny")

        result = await transcriber.transcribe(Path("/nonexistent/file.ogg"))
        assert result is None

    def test_cache_operations(self, executor):
        """Test cache functionality."""
        transcriber = WhisperTranscriber(
            executor=executor,
            model_size="tiny",
            enable_cache=True,
        )

        assert transcriber.enable_cache is True
        assert transcriber._cache is not None

        transcriber.clear_cache()  # Should not raise
