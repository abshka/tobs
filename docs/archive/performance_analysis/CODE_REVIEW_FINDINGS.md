# üïµÔ∏è‚Äç‚ôÇÔ∏è –î–ï–¢–ê–õ–¨–ù–´–ô –ö–û–î-–†–ï–í–¨–Æ: –ü–æ–∏—Å–∫ "—É–±–∏–π—Ü—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏"

–ü–æ –≤–∞—à–µ–º—É –Ω–∞—Å—Ç–æ—è–Ω–∏—é —è –ø—Ä–æ–≤–µ—Ä–∏–ª –≤–µ—Å—å "–≥–æ—Ä—è—á–∏–π –ø—É—Ç—å" (hot-path) —ç–∫—Å–ø–æ—Ä—Ç–∞, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ —Å–∫—Ä—ã—Ç—ã–µ –ø—Ä–∏—á–∏–Ω—ã, –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —Å–µ—Ç—å—é.

–í–æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏:

## 1. Hot Path (`_do_export` loop –≤ `exporter.py`)

```python
batch = []
async for message in self.telegram_manager.get_topic_messages_stream(...):
    batch.append(message)
    if len(batch) >= 75:
        # –û–ë–†–ê–ë–û–¢–ö–ê
```

### ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ö–æ—Ä–æ—à–æ:
- **Batching**: 75 —Å–æ–æ–±—â–µ–Ω–∏–π (–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ).
- **Parallel processing**: `asyncio.gather(*tasks)` –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ.
- **Async I/O**: `await f.write(content)` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –¥–ª—è –≤—Å–µ–≥–æ –±–∞—Ç—á–∞ (—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ).
- **Progress update**: –í—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Å–µ–≥–æ –±–∞—Ç—á–∞ (–Ω–µ –Ω–∞ –∫–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ).

### ‚ö†Ô∏è –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã (–Ω–∞–π–¥–µ–Ω—ã –≤ –∫–æ–¥–µ):

#### A. `_process_message_parallel` –∏ `_get_sender_name`
–î–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (–¥–∞–∂–µ –≤ –±–∞—Ç—á–µ) –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è:
```python
sender_name = await self._get_sender_name(message)
```
–≠—Ç–æ **–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≤—ã–∑–æ–≤**. –ï—Å–ª–∏ `InputPeerCache` –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–ª–∏ –ø—Ä–æ–º–∞—Ö–∏–≤–∞–µ—Ç—Å—è, —ç—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–æ–¥–∏—Ç—å –∫ **—Å–µ—Ç–µ–≤–æ–º—É –∑–∞–ø—Ä–æ—Å—É `get_entity`** –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è!

**–ü—Ä–æ–≤–µ—Ä–∫–∞**:
- –ï—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–∏ –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω—ã ‚Üí –º–≥–Ω–æ–≤–µ–Ω–Ω–æ.
- –ï—Å–ª–∏ –Ω–æ–≤—ã–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–∏ (–≤ –±–æ–ª—å—à–æ–º —á–∞—Ç–µ) ‚Üí network call –Ω–∞ –∫–∞–∂–¥–æ–≥–æ —é–∑–µ—Ä–∞.
- **–í –≤–∞—à–µ–º —Å–ª—É—á–∞–µ**: 493k —Å–æ–æ–±—â–µ–Ω–∏–π, –≤–µ—Ä–æ—è—Ç–Ω–æ –º–Ω–æ–≥–æ —é–∑–µ—Ä–æ–≤. –ï—Å–ª–∏ –∫–µ—à (1000 items) –ø–µ—Ä–µ–ø–æ–ª–Ω—è–µ—Ç—Å—è, —ç—Ç–æ –≤—ã–∑–æ–≤–µ—Ç –º–∞—Å—Å–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã `get_entity`.

#### B. `get_topic_messages_stream` (Batch Fetching)
–ö–æ–¥ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `await self.client.get_messages(...)` –≤ —Ü–∏–∫–ª–µ `while True`.
```python
batch_messages = await self.client.get_messages(..., limit=100, wait_time=config.request_delay)
```
- –ó–¥–µ—Å—å `wait_time`! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥, –Ω–µ —Å—Ç–æ–∏—Ç –ª–∏ —Ç–∞–º –∑–∞–¥–µ—Ä–∂–∫–∞?
- Telethon –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–µ –¥–µ–ª–∞–µ—Ç –∑–∞–¥–µ—Ä–∂–µ–∫, –Ω–æ –µ—Å–ª–∏ `config.request_delay > 0`, –º—ã —Å–∞–º–∏ —Å–µ–±—è —Ç–æ—Ä–º–æ–∑–∏–º.

#### C. `UnifiedThreadPool` Exhaustion
–í `ResourceMonitor` (–∫–æ–≥–¥–∞ –æ–Ω –≤–∫–ª—é—á–µ–Ω) –∏–ª–∏ –≤ –∑–∞–≥—Ä—É–∑–∫–µ –º–µ–¥–∏–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `UnifiedThreadPool`.
–ï—Å–ª–∏ –ø—É–ª –ø–æ—Ç–æ–∫–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ~12 –≤–æ—Ä–∫–µ—Ä–æ–≤) –∑–∞–±–∏—Ç –∑–∞–¥–∞—á–∞–º–∏ (–¥–∞–∂–µ –ø—É—Å—Ç—ã–º–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏ –º–µ–¥–∏–∞), —Ç–æ `aiofiles` (–∫–æ—Ç–æ—Ä—ã–π —Ç–æ–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ—Ç–æ–∫–∏) –º–æ–∂–µ—Ç –∂–¥–∞—Ç—å –æ—á–µ—Ä–µ–¥–∏ –Ω–∞ –∑–∞–ø–∏—Å—å –Ω–∞ –¥–∏—Å–∫.

## üß™ –ì–∏–ø–æ—Ç–µ–∑–∞ "Cache Miss Storm"

–ï—Å–ª–∏ `InputPeerCache` (—Ä–∞–∑–º–µ—Ä 1000) —Å–ª–∏—à–∫–æ–º –º–∞–ª –¥–ª—è —á–∞—Ç–∞ —Å 5000+ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, —Ç–æ `_get_sender_name` –Ω–∞—á–∏–Ω–∞–µ—Ç –¥–µ–ª–∞—Ç—å —Å–µ—Ç–µ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è —Ä–µ–∑–æ–ª–≤–∞ –∏–º–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
1. –ë–∞—Ç—á 75 —Å–æ–æ–±—â–µ–Ω–∏–π.
2. –í –Ω–∏—Ö 20 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —é–∑–µ—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –∫–µ—à–µ (–∏–ª–∏ –≤—ã—Ç–µ—Å–Ω–µ–Ω—ã).
3. `_get_sender_name` –¥–µ–ª–∞–µ—Ç 20 –∑–∞–ø—Ä–æ—Å–æ–≤ `get_entity`.
4. –≠—Ç–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É –±–∞—Ç—á–∞ –Ω–∞ (20 * latency).
5. –í–∏–∑—É–∞–ª—å–Ω–æ: "API time" —Ä–∞—Å—Ç—ë—Ç, –Ω–æ —ç—Ç–æ –Ω–µ `get_messages`, –∞ `get_entity`.

**–ü–æ—á–µ–º—É —ç—Ç–æ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å "—Ç—Ä–æ—Ç—Ç–ª–∏–Ω–≥–æ–º"?**
–ß–µ–º –±–æ–ª—å—à–µ –∑–∞–ø—Ä–æ—Å–æ–≤ `get_entity` –º—ã —à–ª—ë–º, —Ç–µ–º –±—ã—Å—Ç—Ä–µ–µ Telegram –≤–∫–ª—é—á–∞–µ—Ç FloodWait.

## üõ†Ô∏è –ü–ª–∞–Ω –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–¥–∞

### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `request_delay`
–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ `src/config.py` –∏–ª–∏ `.env`, —á–µ–º—É —Ä–∞–≤–µ–Ω `REQUEST_DELAY`. –ï—Å–ª–∏ —Ç–∞–º –Ω–µ 0, —ç—Ç–æ –ø—Ä–∏—á–∏–Ω–∞.

### 2. –£–≤–µ–ª–∏—á–∏—Ç—å `InputPeerCache`
–ï—Å–ª–∏ —á–∞—Ç –±–æ–ª—å—à–æ–π, 1000 —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –º–∞–ª–æ.
–ü—Ä–µ–¥–ª–∞–≥–∞—é —É–≤–µ–ª–∏—á–∏—Ç—å –¥–æ 10,000.

### 3. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å `_get_sender_name`
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `message.sender` (–µ—Å–ª–∏ –æ–Ω —É–∂–µ –ø–æ–¥–≥—Ä—É–∂–µ–Ω Telethon) –≤–º–µ—Å—Ç–æ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ `resolve`.

## –ì–æ—Ç–æ–≤—ã –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–∞—Ç—á "Cache Boost"?

–Ø –º–æ–≥—É –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –ø–∞—Ç—á, –∫–æ—Ç–æ—Ä—ã–π:
1. –£–≤–µ–ª–∏—á–∏—Ç —Ä–∞–∑–º–µ—Ä –∫–µ—à–∞ Peer'–æ–≤ –¥–æ 10,000.
2. –î–æ–±–∞–≤–∏—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é `_get_sender_name`, —á—Ç–æ–±—ã –±—Ä–∞—Ç—å –∏–º—è –∏–∑ —Å–∞–º–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å), –º–∏–Ω—É—è —Ä–µ–∑–æ–ª–≤.

–≠—Ç–æ –º–æ–∂–µ—Ç —É–±—Ä–∞—Ç—å —Å–∫—Ä—ã—Ç—ã–µ —Å–µ—Ç–µ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã. –î–µ–ª–∞–µ–º?
