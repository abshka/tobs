services:
    tobs:
        build:
            context: .
            dockerfile: Dockerfile
            args:
                PYTHON_VERSION: ${PYTHON_VERSION:-3.11.8}

        container_name: tobs
        hostname: tobs

        network_mode: bridge
        stdin_open: true
        tty: true

        restart: unless-stopped

        env_file:
            - .env

        environment:
            # Пути внутри контейнера
            - EXPORT_PATH=/home/appuser/export
            - SESSION_NAME=sessions/tobs_session
            - CACHE_PATH=/home/appuser/cache
            - PYTHONUNBUFFERED=1

        volumes:
            # Данные экспорта
            - ./export:/home/appuser/export:Z

            # Session файлы в отдельной директории
            - ./sessions:/app/sessions:Z

            # Кэш транскрипций
            - ./cache:/home/appuser/cache:Z

        group_add:
            - video
            - ${RENDER_GID:-988}
        # Hardware acceleration для FFmpeg
        devices:
            - /dev/dri:/dev/dri

        # Resource limits для защиты хоста
        deploy:
            resources:
                limits:
                    cpus: '4.0'
                    memory: 8G
                reservations:
                    cpus: '1.0'
                    memory: 2G

        # Healthcheck для мониторинга состояния
        healthcheck:
            test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s

        # Логирование
        logging:
            driver: "json-file"
            options:
                max-size: "10m"
                max-file: "3"
